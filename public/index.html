<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rohan's Voice Interview Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      line-height: 1.5;
    }
    button {
      padding: 10px 14px;
      margin-top: 10px;
      cursor: pointer;
      font-size: 16px;
    }
    input {
      padding: 10px;
      width: 70%;
      font-size: 16px;
    }
    #question, #answer {
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 20px;
      margin-top: 5px;
    }
    #answer {
      background: #f3f3f3;
    }
  </style>
</head>
<body>

  <h2>Rohan's Voice Interview Bot</h2>

  <button id="unlockBtn">ðŸ”“ Tap to Enable Voice</button><br>
  <button id="startBtn" disabled>ðŸŽ¤ Start Talking</button>
  <div id="status">Status: Waiting for voice unlock...</div>

  <h3>You asked:</h3>
  <div id="question">(nothing yet)</div>

  <h3>Rohan replied:</h3>
  <div id="answer">(no reply yet)</div>

  <h3>Or type your question:</h3>
  <input id="textInput" placeholder="Ask something..." />
  <button id="sendBtn">Send</button>

  <script>
    const unlockBtn = document.getElementById("unlockBtn");
    const startBtn = document.getElementById("startBtn");
    const statusEl = document.getElementById("status");
    const questionEl = document.getElementById("question");
    const answerEl = document.getElementById("answer");
    const textInput = document.getElementById("textInput");
    const sendBtn = document.getElementById("sendBtn");

    let voiceUnlocked = false;

    // ---------------------------
    // 1ï¸âƒ£ Unlock voice on mobile
    // ---------------------------
    unlockBtn.addEventListener("click", () => {
      const test = new SpeechSynthesisUtterance("Voice unlocked");
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(test);

      voiceUnlocked = true;
      unlockBtn.disabled = true;
      unlockBtn.innerText = "ðŸ”“ Voice Enabled";
      startBtn.disabled = false;

      statusEl.textContent = "Status: Voice enabled. You can talk now.";
    });

    // ---------------------------
    // 2ï¸âƒ£ Speak function (safe)
    // ---------------------------
    function speak(text) {
      if (!voiceUnlocked) {
        console.warn("Voice still locked. User must tap unlock button first.");
        return;
      }

      if (!("speechSynthesis" in window)) {
        console.warn("Speech synthesis not supported.");
        return;
      }

      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-IN";
      utter.rate = 1;
      utter.pitch = 1;

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    // ---------------------------
    // 3ï¸âƒ£ Send text to API
    // ---------------------------
    async function sendToBot(msg) {
      questionEl.textContent = msg;
      statusEl.textContent = "Status: Thinking...";

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg }),
        });

        const data = await res.json();
        const reply = data.reply || "Sorry, I couldn't think of a reply.";

        answerEl.textContent = reply;
        statusEl.textContent = "Status: Ready";

        // ðŸ”Š SPEAK HERE
        speak(reply);

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error communicating with server.";
        answerEl.textContent = "Something went wrong, please try again.";
      }
    }

    // ---------------------------
    // 4ï¸âƒ£ Text input handling
    // ---------------------------
    sendBtn.addEventListener("click", () => {
      const msg = textInput.value;
      textInput.value = "";
      sendToBot(msg);
    });

    textInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    // ---------------------------
    // 5ï¸âƒ£ Voice input (Android only)
    // ---------------------------
    let recognition = null;

    if ("webkitSpeechRecognition" in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "en-IN";
      recognition.interimResults = false;

      recognition.onstart = () => {
        statusEl.textContent = "Status: Listening...";
      };
      recognition.onerror = () => {
        statusEl.textContent = "Status: Error using voice.";
      };
      recognition.onend = () => {
        statusEl.textContent = "Status: Ready";
      };

      recognition.onresult = (event) => {
        const msg = event.results[0][0].transcript;
        sendToBot(msg);
      };
    } else {
      startBtn.innerText = "ðŸŽ¤ Voice not supported on this device";
      startBtn.disabled = true;
    }

    // Start listening
    startBtn.addEventListener("click", () => {
      if (recognition) recognition.start();
    });
  </script>

</body>
</html>
